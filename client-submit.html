<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>SSE Demo - Submit</title>
  <style>
      body {
          font-family: Arial, sans-serif;
          max-width: 800px;
          margin: 50px auto;
          padding: 20px;
      }

      #messages {
          border: 1px solid #ccc;
          padding: 15px;
          min-height: 200px;
          background: #f9f9f9;
          border-radius: 5px;
          margin-top: 20px;
      }

      .message {
          padding: 8px;
          margin: 5px 0;
          background: white;
          border-left: 3px solid #007bff;
          border-radius: 3px;
      }

      .message pre {
          margin: 0;
      }

      .error {
          border-left-color: #dc3545;
          color: #dc3545;
      }

      .success {
          border-left-color: #28a745;
          color: #28a745;
      }

      button {
          padding: 10px 20px;
          background: #007bff;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 16px;
      }

      button:hover {
          background: #0056b3;
      }

      button:disabled {
          background: #ccc;
          cursor: not-allowed;
      }
  </style>
</head>

<body>
<h1>Server-Sent Events Demo (Submit)</h1>
<button id="submitBtn" onclick="submitAndListen()">Submit & Listen</button>
<div id="messages"></div>

<script>
  const messages = document.getElementById("messages");
  const submitBtn = document.getElementById("submitBtn");
  let currentEventSource = null;

  function addMessage(text, type = 'info') {
    const p = document.createElement("p");
    p.className = `message ${type}`;
    p.textContent = text;
    messages.appendChild(p);
    messages.scrollTop = messages.scrollHeight;
  }

  function addJson(data, type = 'info', prefix = '') {
    const p = document.createElement('p');
    p.className = `message ${type}`;
    if (prefix) {
      const span = document.createElement('span');
      span.textContent = prefix + '\n';
      p.appendChild(span);
    }
    const pre = document.createElement('pre');
    pre.textContent = JSON.stringify(data, null, 2);
    p.appendChild(pre);
    messages.appendChild(p);
    messages.scrollTop = messages.scrollHeight;
  }

  // H√†m g·ª≠i API v√† l·∫Øng nghe SSE
  async function submitAndListen() {
    // Disable button ƒë·ªÉ tr√°nh spam
    submitBtn.disabled = true;
    messages.innerHTML = '';

    // ƒê√≥ng connection c≈© n·∫øu c√≥
    if (currentEventSource) {
      currentEventSource.close();
      currentEventSource = null;
    }

    // Body g·ª≠i l√™n API (submit: ch·ªâ c·∫ßn languageId v√† sourceCode)
    const body = {
      languageId: 11,
      problemId: 1,
      testCases: [
        {
          input: "2 3\n",
          output: "5\n"
        },
        {
          input: "10 20\n",
          output: "30\n"
        }
      ],
      sourceCode: `#include <iostream>\n\nint main() {\n    int soThuNhat, soThuHai, tong;\n\n    std::cin >> soThuNhat;\n\n    std::cin >> soThuHai;\n    tong = soThuNhat + soThuHai;\n\n    std::cout << tong << std::endl;\n\n    return 0;\n}`
    };

    addMessage("ƒêang g·ª≠i code l√™n server (submit)...");

    // G·ª≠i API l·∫•y submissionId
    let submissionId = null;
    try {
      const res = await fetch("http://localhost:3000/v1/submissions/submit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsImVtYWlsIjoiYWRtaW5Ac2ZpbnguY29tIiwidXNlcm5hbWUiOiJhZG1pbiIsInJvbGUiOiJhZG1pbiIsImlhdCI6MTc2Njg0ODY3MywiZXhwIjoxNzY2ODQ5NTczfQ.ka_ZWaV01O-826qkdbs5499eCQgXXWwGcV8plARGZVOcUIFQY53j3aw_jNKdmoF8S51mZHY2K_BTxXveThItIcEkUicxJgyV4K374BQqPjs9gDxWDQ1FbAkPSHo_Tj9JAWWDolIcSw09jC_bpehv8c38bjH8FSFFfuBX7bjRGCIotyJ2lxgNH5uEyL4TFx6HzoAU7otfRGy5jQDKFGW5MkYfocLlheXuH-y2_-kr-jIL18aV0a4pZjR_dBhylJK5huyPai6lFC_tmhgld40yozrY5WJ1OF5urOK7obVVVdS3LbROoPW-d10XL0WvIArbOCRFjznnvfSBTMRh1XTrqw"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }

      const data = await res.json();
      console.log("Response:", data);

      if (data && data.data && data.data.submissionId) {
        submissionId = data.data.submissionId;
        addMessage(`‚úì Submission ID: ${submissionId}`, 'success');
      } else {
        addMessage("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c submissionId t·ª´ response!", 'error');
        submitBtn.disabled = false;
        return;
      }
    } catch (err) {
      addMessage(`‚ùå L·ªói g·ª≠i API: ${err.message}`, 'error');
      console.error(err);
      submitBtn.disabled = false;
      return;
    }

    // K·∫øt n·ªëi SSE v·ªõi submissionId
    const sseUrl = `http://localhost:3000/v1/submissions/${submissionId}/stream`;
    addMessage(`ƒêang k·∫øt n·ªëi SSE: ${sseUrl}`);

    currentEventSource = new EventSource(sseUrl);

    currentEventSource.onopen = function () {
      addMessage("‚úì SSE connection opened", 'success');
    };

    currentEventSource.onmessage = function (event) {
      console.log("SSE message:", event.data);
      try {
        // Th·ª≠ parse JSON n·∫øu data l√† JSON
        const jsonData = JSON.parse(event.data);
        addJson(jsonData, 'info', 'üì®');
      } catch {
        // N·∫øu kh√¥ng ph·∫£i JSON th√¨ hi·ªÉn th·ªã text th∆∞·ªùng
        addMessage(`üì® ${event.data}`);
      }
    };

    // L·∫Øng nghe c√°c event type kh√°c n·∫øu server g·ª≠i
    currentEventSource.addEventListener('status', function (event) {
      addMessage(`üìä Status: ${event.data}`);
    });

    currentEventSource.addEventListener('result', function (event) {
      try {
        const jsonData = JSON.parse(event.data);
        addJson(jsonData, 'success', '‚úÖ Result:');
      } catch {
        addMessage(`‚úÖ Result: ${event.data}`, 'success');
      }
    });

    currentEventSource.addEventListener('error_event', function (event) {
      addMessage(`‚ö†Ô∏è Error: ${event.data}`, 'error');
    });

    currentEventSource.onerror = function (err) {
      console.error("SSE error:", err);
      addMessage("‚ùå SSE connection error ho·∫∑c ƒë√£ ƒë√≥ng", 'error');
      currentEventSource.close();
      currentEventSource = null;
      submitBtn.disabled = false;
    };

    // T·ª± ƒë·ªông ƒë√≥ng connection sau 30 gi√¢y
    setTimeout(() => {
      if (currentEventSource) {
        addMessage("‚è±Ô∏è Timeout - ƒë√≥ng connection");
        currentEventSource.close();
        currentEventSource = null;
        submitBtn.disabled = false;
      }
    }, 30000);
  }
</script>
</body>

</html>